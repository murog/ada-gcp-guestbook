steps:
- id: 'install backend deps'
  name: 'gcr.io/cloud-builders/npm'
  dir: 'backend'
  args: ['install']

- id: 'run backend unit tests'
  name: 'gcr.io/cloud-builders/npm'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
      set -euo pipefail
      # set env vars
      cp example.env .env
      # run tests
      npm test

- id: 'build backend image'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
    docker build -t gcr.io/ada-workshop-3/backend:$SHORT_SHA .

- id: 'run backend container'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
      set -euo pipefail
      # run container with name "backend"
      # on network "cloudbuild"
      # exposing ports 8000
      # in detached mode
      docker run --name backend --network cloudbuild -p 8000:8000 -d gcr.io/ada-workshop-3/backend:$SHORT_SHA
      # confirm container is running
      docker ps
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
    curl -i backend:8000/messages
    curl -i backend:8000/stickers

- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
    docker push gcr.io/ada-workshop-3/backend:$SHORT_SHA

- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  dir: 'backend'
  args:
  - '-c'
  - |
    gcloud beta run deploy backend --image gcr.io/ada-workshop-3/backend:$SHORT_SHA --platform managed --region us-central1